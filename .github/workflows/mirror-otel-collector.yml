name: Mirror OTel Collector (DHI)

# Mirrors the Docker Hardened Image (DHI) of OpenTelemetry Collector
# to ghcr.io/nirmata/otel-collector.
#
# Source: dhi.io/opentelemetry-collector:<version>-contrib
# Target: ghcr.io/nirmata/otel-collector:nirmata-<version>
#
# The DHI contrib image is:
#   - Free (CIS-compliant, zero CVEs)
#   - Multi-arch (linux/amd64 + linux/arm64)
#   - Runs as nonroot (65532:65532)
#   - Includes contrib components (prometheus receiver, prometheusremotewrite exporter, etc.)

on:
  workflow_dispatch:
    inputs:
      otel_version:
        description: 'DHI OpenTelemetry Collector version (e.g., 0.145.0)'
        required: true
        type: string
      variant:
        description: 'Image variant'
        required: false
        default: 'contrib'
        type: choice
        options:
          - contrib
          - core
      push:
        description: 'Push image to GHCR'
        required: false
        default: true
        type: boolean

env:
  SOURCE_REGISTRY: dhi.io
  SOURCE_IMAGE: opentelemetry-collector
  TARGET_REGISTRY: ghcr.io/nirmata
  TARGET_IMAGE: otel-collector

permissions:
  contents: read
  packages: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Validate input version
        run: |
          if [[ ! "${{ inputs.otel_version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version must be in format X.Y.Z (e.g., 0.145.0)"
            exit 1
          fi

          if [[ "${{ inputs.variant }}" == "contrib" ]]; then
            echo "SOURCE_TAG=${{ inputs.otel_version }}-contrib" >> $GITHUB_ENV
          else
            echo "SOURCE_TAG=${{ inputs.otel_version }}" >> $GITHUB_ENV
          fi
          echo "NIRMATA_TAG=nirmata-${{ inputs.otel_version }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DHI registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SOURCE_REGISTRY }}
          username: ${{ secrets.DHI_USERNAME }}
          password: ${{ secrets.DHI_PASSWORD }}

      - name: Log in to GHCR
        if: ${{ inputs.push }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.IMAGE_PUSH_PAT }}

      - name: Inspect source image
        run: |
          SOURCE="${{ env.SOURCE_REGISTRY }}/${{ env.SOURCE_IMAGE }}:${{ env.SOURCE_TAG }}"
          echo "## Source Image" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${SOURCE}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Inspecting source image: ${SOURCE}"
          docker buildx imagetools inspect "${SOURCE}"

      - name: Mirror multi-arch image to GHCR
        if: ${{ inputs.push }}
        run: |
          SOURCE="${{ env.SOURCE_REGISTRY }}/${{ env.SOURCE_IMAGE }}:${{ env.SOURCE_TAG }}"
          TARGET="${{ env.TARGET_REGISTRY }}/${{ env.TARGET_IMAGE }}:${{ env.NIRMATA_TAG }}"
          TARGET_LATEST="${{ env.TARGET_REGISTRY }}/${{ env.TARGET_IMAGE }}:latest"

          echo "Mirroring: ${SOURCE} -> ${TARGET}"
          docker buildx imagetools create \
            --tag "${TARGET}" \
            --tag "${TARGET_LATEST}" \
            "${SOURCE}"

      - name: Verify mirrored image
        if: ${{ inputs.push }}
        run: |
          TARGET="${{ env.TARGET_REGISTRY }}/${{ env.TARGET_IMAGE }}:${{ env.NIRMATA_TAG }}"
          echo "Verifying mirrored image: ${TARGET}"
          docker buildx imagetools inspect "${TARGET}"

      - name: Summary
        run: |
          echo "## Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source** | \`${{ env.SOURCE_REGISTRY }}/${{ env.SOURCE_IMAGE }}:${{ env.SOURCE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | \`${{ env.TARGET_REGISTRY }}/${{ env.TARGET_IMAGE }}:${{ env.NIRMATA_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Variant** | ${{ inputs.variant }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **OTel Version** | ${{ inputs.otel_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Architectures** | linux/amd64, linux/arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Pushed** | ${{ inputs.push }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.push }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.TARGET_REGISTRY }}/${{ env.TARGET_IMAGE }}:${{ env.NIRMATA_TAG }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

